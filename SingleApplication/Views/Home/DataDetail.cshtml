@using BusinessHandler.Model;
@using Newtonsoft.Json;
@using System.Configuration;
@{

    ViewBag.Title = "DataDetail";
    var model = (List<DocQueryResultModel>)Model;
    var keyWords = ConfigurationManager.AppSettings["KeyWords"].Split(';');

}
<h2>Data Detail</h2>
<script>

    @{foreach (var r in model.Select(x=>x.CityName).Distinct().ToList())
        {
            var cityName = r;
            var dates = model.Where(x => x.CityName.Equals(r)).Select(y => y.MeetingDateDisplay).Distinct().ToArray();
            var json = new HtmlString(JsonConvert.SerializeObject(dates));
           <text>
    sessionStorage.setItem("@cityName", '@json');
       </text>
     }
}
</script>
<div class="panel-body" style="padding-bottom:0px;">
    <div class="panel panel-default">
        <div class="panel-heading">Searh Criteria</div>
        <div>
            <form id="formSearch" class="form-horizontal">
                <div class="form-group" style="margin-top:15px">
                    <label class="control-label col-sm-2" for="txt_search_CityName " style="width:10%">City Name</label>
                    <div class="col-sm-2">
                        <select id="sel_search_CityName" multiple="multiple">
                            @{
                                foreach (var r in model.GroupBy(x => x.CityName))
                                {
                                    <option value="@r.Key">@r.Key</option>

                                }
                            }

                        </select>
                        @*<input type="text" class="form-control" id="txt_search_CityName">*@
                    </div>
                    <label class="control-label col-sm-2" for="txt_search_MeetingDate" style="width:12%">Meeting Date</label>
                    <div class="col-sm-2">
                        <input type="text" class="form-control" id="txt_search_MeetingDate">
                    </div>
                    <label class="control-label col-sm-2" for="sel_search_KeyWord" style="width:10%">Key Word</label>
                    <div class="col-sm-2">
                        @*<input type="text" class="form-control" id="txt_search_KeyWord">*@
                        <select id="sel_search_KeyWord" multiple="multiple">
                            @{
                                foreach (var r in keyWords)
                                {
                                    <option value="@r">@r</option>

                                }
                            }

                        </select>

                    </div>
                    <div class="col-sm-2" style="text-align:left;">
                        <button type="button" style="margin-left:10px" id="btn_Query" class="btn btn-primary">Search</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div>
        <table id="tb_departments" ></table>

    </div>

</div>

<div class="modal fade" tabindex="-1" role="dialog" id="myModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Add Comments</h4>
            </div>
            <div class="modal-body">
                <input type="hidden" id="hid_DocId" />
                <input type="hidden" id="hid_FilePath" />
                <input type="hidden" id="hid_QueryGuid" />
                <textarea class="form-control" rows="3" id="txt_Comments"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btn_Save_Comment">Save changes</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script>
    $(function () {
        var oTable = new TableInit();
        oTable.Init();

        var oButtonInit = new ButtonInit();
        oButtonInit.Init();

    });

    var TableInit = function () {
        var oTableInit = new Object();
        oTableInit.Init = function () {
            $('#tb_departments').bootstrapTable({
                url: '/Home/GetParentDataList',
                method: 'get',
                cache: false,
                pagination: true,
                sortable: true,
                queryParams: oTableInit.queryParams,
                sidePagination: "server",
                pageList: [10, 25, 50, 100],
                showColumns: true,
                detailView: true,
                achillesToolbar:true,
                columns: [
                    {
                        field: 'DocUrl',
                        title: ' Document',
                        sortable: true
                    },
                    {
                          field: 'DocType',
                          title: 'Type',
                          sortable: true
                    },
                    //{
                    //    field: 'KeyWordString',
                    //    title: 'Key Words',
                    //    sortable: true
                    //},
                     
                    {
                        field: 'Number',
                        title: 'Number',
                        sortable: true
                    },
                    {
                        field: 'IsViewed',
                        title: 'View',
                        sortable: true
                    }
                ],
  
                onExpandRow: function (index, row, $detail) {
                    oTableInit.InitSubTable(index, row, $detail);
                },
                onLoadSuccess: function (data) {
                    for (var i = 0; i < data.rows.length; i++) {
                        var doc = data.rows[i];
                        sessionStorage.setItem(doc.DocId, JSON.stringify(doc.DocQuerySubList));  
                    }
                    $("#tb_departments").children().eq(1).children().each(function () {
                        if ($(this).children(":last").children().html() == "No") {
                            $(this).css("background-color", "#eee");
                        }
                    });
                },

            });
        };


        oTableInit.queryParams = function (params) {
            var keyWord = "";
            var cityName = "";
            var isViewed = "";
            if ($("#sel_search_KeyWord").val() != null)
            {
                keyWord = $("#sel_search_KeyWord").val().toString();
            }
            if ($("#sel_search_CityName").val() != null) {
                cityName = $("#sel_search_CityName").val().toString();
            }
            if ($("#div_status_select").attr("data-status") != null) {
                isViewed = $("#div_status_select").attr("data-status");
            }

            var temp = {
                limit: params.limit,
                offset: params.offset,
                CityName: cityName,
                MeetingDate: $("#txt_search_MeetingDate").val(),
                KeyWord: keyWord,
                IsViewed: isViewed,
                sortName:this.sortName,
               sortOrder: this.sortOrder
            };
            return temp;
        };

        oTableInit.InitSubTable = function (index, row, $detail) {
            var parentid = row.DocId;
            var filePath = row.DocFilePath;
            $(".sp_" + parentid).parent().parent().css("background-color", "#fff");
            var isViewed = $(".sp_" + parentid).html();
            if (isViewed != "Yes") {
                $(".sp_" + parentid).html("Yes");
                $.ajax({
                    url: '@Url.Action("UpdateDocStatus", "Home")',
                    data: { DocId: parentid, DocFilePath: filePath },
                    dataType: 'json',
                    type: "POST",
                    success: function (result) {
                    },
                    complete: function (XMLHttpRequest, textStatus) {
                    },
                    error: function (xhr, textStatus, errorThrown) {

                    }
                });
            }
            var dataList = JSON.parse(sessionStorage.getItem(parentid));
            var cur_table = $detail.html('<table></table>').find('table');
            $(cur_table).bootstrapTable({
                data: dataList,
                columns: [
                    {
                        field: 'CityNameDispaly',
                        title: 'City',
                        sortable: true
                    },
                    {
                        field: 'MeetingDateDisplay',
                        title: 'Meeting Date',
                        sortable: true
                    },
                    {
                        field: 'PageNumber',
                        title: 'Page',
                        sortable: true
                    },
                  
                    {
                        field: 'KeyWord',
                        title: 'Key Word',
                        sortable: true
                    },

                    {
                        field: 'Content',
                        title: 'Content'
                    },
                    {
                        field: 'Comment',
                        title: 'Comment'
                    },
                    {
                        field: 'Operation',
                        title: 'Operation',
                        align: 'center'
                    }
                ],
 
            });
        };

        return oTableInit;
    };


    var ButtonInit = function () {
        var oInit = new Object();
        var postdata = {};

        oInit.Init = function () {
            //初始化页面上面的按钮事件
        };

        return oInit;
    };

    $(document).ready(function () {
        $('#sel_search_CityName').multiselect({
            buttonWidth: '160px',
            includeSelectAllOption: true
        });
        $('#sel_search_KeyWord').multiselect({
            buttonWidth: '160px',
            includeSelectAllOption: true
        });
        $('#txt_search_MeetingDate').datepicker({
            format: 'yyyy/mm/dd'
        });
        $("#btn_Query").click(function () {

            SearchData();
        });
        $("#btn_Save_Comment").click(function () {
            $.ajax({
                url: '@Url.Action("SaveComment", "Home")',
                data: { DocId: $("#hid_DocId").val(), Comment: $("#txt_Comments").val(), QueryFilePath: $("#hid_FilePath").val(), QueryGuid: $("#hid_QueryGuid").val()},
                dataType: 'json',
                type: "POST",
                success: function (result) {
                    alert("success");
                },
                complete: function (XMLHttpRequest, textStatus) {
                    $('#' + $("#hid_QueryGuid").val()).html($("#txt_Comments").val());
                    $("#myModal").modal('hide');
                },
                error: function (xhr, textStatus, errorThrown) {

                }
            });
        });

    });
    function OpenDataDetail(obj)
    {
        var docId = $(obj).attr("data-docid");
        var filePath = $(obj).attr("data-file");
        var queryGuid = $(obj).attr("data-queryguid");
        var comment = $(obj).parent().prev().children().html();
        $("#hid_DocId").val(docId);
        $("#hid_FilePath").val(filePath);
        $("#myModal").modal('show');
        $("#hid_QueryGuid").val(queryGuid);
        $("#txt_Comments").val(comment);
    }
    function showDatePicker(obj) {
        var currentDate = $(obj).parent().next().html();
        var city = $(obj).html();
        var active_dates = JSON.parse(sessionStorage.getItem(city));

        $(obj).datepicker({
            format: "yyyy/mm/dd",
            autoclose: true,
            beforeShowDay: function (date) {
                var d = date;
                var curr_date = d.getDate();
                var month = d.getMonth() + 1;//Months are zero based
                var curr_month = month < 10 ? '0' + month : '' + month;
                var curr_year = d.getFullYear();
                var formattedDate = curr_year + "/" + curr_month + "/" + curr_date

                if ($.inArray(formattedDate, active_dates) != -1) {
                    return {
                        classes: 'activeClass'
                    };
                }
                return;
            }
        });
        $(obj).datepicker('setDate', currentDate);
        $(obj).datepicker('show');
      //  $(obj)

    }
    function ShowStatus(obj) {
        var selectedStatus = $(obj).children().html()
        var isViewed = "";
        if ($("#div_status_select").attr("data-status") != null) {
            isViewed = $("#div_status_select").attr("data-status");
        }
        if (isViewed != selectedStatus) {
            $("#div_status_select").attr("data-status", selectedStatus);
            SearchData();
        }
    }
    function SearchData()
    {
        var keyWord = "";
        var cityName = "";
        var isViewed = "";
        if ($("#sel_search_KeyWord").val() != null) {
            keyWord = $("#sel_search_KeyWord").val().toString();
        }
        if ($("#sel_search_CityName").val() != null) {
            cityName = $("#sel_search_CityName").val().toString();
        }
        if ($("#div_status_select").attr("data-status") != null) {
            isViewed = $("#div_status_select").attr("data-status");
        }
        
        var tempQueryParams = function () {
            var temp = {
                CityName: cityName,
                MeetingDate: $("#txt_search_MeetingDate").val(),
                KeyWord: keyWord,
                IsViewed: isViewed
            };
            return temp;
        };

        $("#tb_departments").bootstrapTable('refresh', { queryParams: tempQueryParams, pageNumber: 1, pageSize: 10 });
    }
</script>


